{"version":3,"names":["fs","_interopRequireWildcard","require","path","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","RequirementValidator","constructor","templatesPath","bookChapterIndex","Map","validate","requirements","result","isValid","errors","warnings","buildChapterIndex","req","validateIDFormat","validateNestingDepth","bookFiles","file","letter","bookName","info","entries","templatePath","join","existsSync","content","promises","readFile","chapterMap","lines","split","line","match","chapterNum","parseInt","chapterTitle","trim","toLowerCase","idPattern","test","id","push","parts","bookLetterMap","expectedLetter","book","bookChapters","normalizedChapterTitle","chapter","expectedChapterNum","undefined","parent","startsWith","length","exports"],"sources":["validator.ts"],"sourcesContent":["import { Requirement } from './types';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as core from '@actions/core';\n\nexport interface ValidationResult {\n    isValid: boolean;\n    errors: string[];\n    warnings: string[];\n}\n\nexport class RequirementValidator {\n    private templatesPath: string;\n    // Map<BookName, Map<ChapterNameNormalized, ChapterNumber>>\n    private bookChapterIndex: Map<string, Map<string, number>>;\n\n    constructor(templatesPath: string) {\n        this.templatesPath = templatesPath;\n        this.bookChapterIndex = new Map();\n    }\n\n    public async validate(requirements: Requirement[]): Promise<ValidationResult> {\n        const result: ValidationResult = { isValid: true, errors: [], warnings: [] };\n\n        await this.buildChapterIndex();\n\n        for (const req of requirements) {\n            this.validateIDFormat(req, result);\n            this.validateNestingDepth(req, result);\n        }\n\n        return result;\n    }\n\n    private async buildChapterIndex() {\n        // Known PEGS books and valid prefixes\n        const bookFiles = new Map([\n            ['Goals Book', { file: 'goals.adoc', letter: 'G' }],\n            ['Environment Book', { file: 'environment.adoc', letter: 'E' }],\n            ['Project Book', { file: 'project.adoc', letter: 'P' }],\n            ['System Book', { file: 'system.adoc', letter: 'S' }]\n        ]);\n\n        for (const [bookName, info] of bookFiles.entries()) {\n            const templatePath = path.join(this.templatesPath, info.file);\n            if (!fs.existsSync(templatePath)) continue;\n\n            const content = await fs.promises.readFile(templatePath, 'utf-8');\n            const chapterMap = new Map<string, number>();\n\n            const lines = content.split('\\n');\n            for (const line of lines) {\n                // Match \"== G.1 Context...\"\n                const match = line.match(/^==\\s+([A-Z])\\.(\\d+)\\s+(.+)$/);\n                if (match) {\n                    const chapterNum = parseInt(match[2], 10);\n                    const chapterTitle = match[3].trim();\n                    chapterMap.set(chapterTitle.toLowerCase(), chapterNum);\n                }\n            }\n            this.bookChapterIndex.set(bookName, chapterMap);\n        }\n    }\n\n    private validateIDFormat(req: Requirement, result: ValidationResult) {\n        // Regex: Letter.Num.Num...\n        // e.g. G.1.2 or G.3.1.2.5\n        const idPattern = /^[GEPS]\\.\\d+(\\.\\d+)*$/;\n\n        if (!idPattern.test(req.id)) {\n            result.errors.push(`Requirement ${req.id}: ID format invalid. Must be <Letter>.<Chapter>.<ID> (e.g., G.1.1).`);\n            result.isValid = false;\n            return;\n        }\n\n        const parts = req.id.split('.');\n        const letter = parts[0];\n        const chapterNum = parseInt(parts[1], 10);\n\n        // Check consistency with Book\n        const bookLetterMap: { [key: string]: string } = {\n            'Goals Book': 'G',\n            'Environment Book': 'E',\n            'Project Book': 'P',\n            'System Book': 'S'\n        };\n\n        const expectedLetter = bookLetterMap[req.book];\n        if (expectedLetter && letter !== expectedLetter) {\n            result.errors.push(`Requirement ${req.id}: ID starts with '${letter}' but belongs to '${req.book}' (expected '${expectedLetter}').`);\n            result.isValid = false;\n        }\n\n        // Check consistency with Chapter\n        const bookChapters = this.bookChapterIndex.get(req.book);\n        if (bookChapters) {\n            const normalizedChapterTitle = req.chapter.toLowerCase().trim();\n            const expectedChapterNum = bookChapters.get(normalizedChapterTitle);\n\n            if (expectedChapterNum !== undefined && chapterNum !== expectedChapterNum) {\n                result.errors.push(`Requirement ${req.id}: ID indicates chapter ${chapterNum} but belongs to chapter \"${req.chapter}\" (expected ${expectedChapterNum}).`);\n                result.isValid = false;\n            }\n        }\n\n        // Check Parent consistency\n        if (req.parent) {\n            if (!req.id.startsWith(req.parent + '.')) {\n                result.errors.push(`Requirement ${req.id}: ID consistent with parent ${req.parent}. Child ID must start with Parent ID.`);\n                result.isValid = false;\n            }\n        }\n    }\n\n    private validateNestingDepth(req: Requirement, result: ValidationResult) {\n        // G.1.2 -> depth 3 (parts length)\n        // We consider \"G.1.2\" as depth 1 relative to chapter? \n        // Request: \"warn if deep\". Let's say max 6 parts (e.g. G.1.2.3.4.5)\n\n        const parts = req.id.split('.');\n        if (parts.length > 6) {\n            result.warnings.push(`Requirement ${req.id}: Nesting is very deep (${parts.length} levels). Consider refactoring.`);\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}