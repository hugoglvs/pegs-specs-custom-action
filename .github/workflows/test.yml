name: Test Action

on: [push, workflow_dispatch]

jobs:
  test-generation:
    runs-on: ubuntu-latest
    name: Test PDF Generation
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Dummy Assets
        run: |
          mkdir -p assets
          printf "@startuml\nUser->System:Test\n@enduml" > assets/diagram.puml
          # Create a tiny red dot SVG
          echo '<svg width="10" height="10"><circle cx="5" cy="5" r="4" fill="red"/></svg>' > assets/image.svg

      - name: Create Test Requirements
        run: |
          echo "id,book,chapter,description,reference to,attached files" > requirements.csv
          echo "G.1,Goals Book,Context and overall objective,Testing PDF gen.,,assets/diagram.puml" >> requirements.csv
          echo "S.1,System Book,Components,Testing Image.,,assets/image.svg" >> requirements.csv
          echo "P.1,Project Book,Roles and personnel,Senior developer Hugo.,," >> requirements.csv
          echo "E.1,Environment Book,Glossary,PEGS stands for Project Environment Goals System.,," >> requirements.csv
          echo "G.2,Goals Book,Context and overall objective,The system shall run on Linux.,," >> requirements.csv
          echo "S.2,System Book,Components,The system shall have a 3-tier architecture.,G.1,\"assets/diagram.puml\"" >> requirements.csv

      - name: Run PEGS Specs Action
        uses: ./
        with:
          requirements-path: "requirements.csv"
          output-dir: "docs/build"

      - name: Verify Artifacts
        run: |
          ls -R docs/build
          # Check for Consolidated PDF
          if [ ! -f docs/build/full-specs.pdf ]; then
            echo "full-specs.pdf not generated!"
            exit 1
          fi
          # Check for Index HTML
          if [ ! -f docs/build/index.html ]; then
            echo "index.html not generated!"
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-specs
          path: docs/build
